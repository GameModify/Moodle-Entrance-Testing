# Moodle Module (entrance testing)

Локальный плагин Moodle (`moodle-module/`) для автоматического распределения студентов на курсы по результатам входного теста.

### Основные функции

- Отслеживает завершение входного теста (событие `mod_quiz\event\attempt_graded`).
- Складывает попытки в очередь в собственной таблице БД.
- Через cron-задачи отправляет данные о попытках на внешний API.
- Настраивается из админ‑панели Moodle (URL API, ID теста, таймауты, количество попыток и т.п.).

### Структура плагина

- `lib.php` — обработка событий теста и отправка очереди на внешний API.
- `classes/task/` — фоновые задачи (cron) по обработке очереди.
- `db/` — описание таблицы очереди событий.
- `lang/` — локализация (ru/en).
- `settings.php`, `admin.php`, `task.php`, `version.php` — интеграция с админкой Moodle.

### Подключение плагина

1. Скопируйте папку `moodle-module` в директорию `/local/` вашего Moodle-сервера.
2. Зайдите под администратором, выполните обновление БД и установку плагина.
3. В админке перейдите в:
   - «Администрирование сайта → Плагины → Локальные плагины → Входное тестирование».
4. В настройках укажите:
   - **URL API**: `http://<ваш-сервер>:8000/analyze-and-enroll`
   - **ID входного теста**
   - Таймаут запроса, количество попыток, SSL‑настройки — при необходимости.
5. Нажмите «Проверить соединение», чтобы убедиться, что FastAPI‑сервис доступен.

### Создание сервиса и токена для REST API Moodle

Чтобы Python-сервис мог зачислять студентов и получать детали попыток теста через Moodle REST API, необходимо создать **сервис и токен пользователя**:

1. Зайдите в админку Moodle → **Администрирование сайта → Сервер → Веб-сервисы → Управление сервисами**.
2. Создайте новый сервис, например `Entrance Testing API`, и отметьте **включить сервис**.
3. Добавьте нужные функции,
   - `mod_quiz_get_attempt_review` — просмотр последней попытки пользователя в тесте
   - `enrol/manual:enrol` — зачисление на курс  
   - И другие, которые необходимы для вашей логики.
4. Сохраните сервис.
5. Создайте **токен для пользователя** (обычно для администратора или пользователя с правами зачисления):
   - Админка → **Администрирование сайта → Пользователи → Управление токенами**.
   - Выберите сервис `Entrance Testing API`, пользователя и нажмите **Создать токен**.
6. Полученный токен укажите в `.env` вашего Python-сервиса (`MOODLE_TOKEN`).
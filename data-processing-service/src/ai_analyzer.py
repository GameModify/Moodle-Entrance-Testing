import aiohttp
import json
import uuid
from config import settings


PROMPT_TEMPLATE = """
Ты — опытный преподаватель, специализирующийся на подготовке ИТ-специалистов.
Твоя задача — оценить уровень профессиональной подготовки по результатам входного теста.

Данные теста:
{results}

Каждый вопрос содержит:
- текст вопроса по различным областям ИТ-знаний (программирование, базы данных, веб-разработка, системное администрирование и т. д.)
- варианты ответов
- выбранный обучающимся ответ
- правильный ответ
- балл за вопрос (score)
- состояние (state: gradedright / gradedwrong / notanswered)

Правила оценки уровня профессиональной подготовки:

1. Анализ полноты ответов:
   Определи количество отвеченных и неотвеченных вопросов.
   Учти, что неполнота ответов может указывать на недостаточный уровень подготовки.

2. Анализ правильности ответов по областям ИТ-знаний:
   Проанализируй правильность ответов по каждой области ИТ-компетенций:
   - Программирование (базовые конструкции, алгоритмы, структуры данных)
   - Базы данных (SQL, проектирование, нормализация)
   - Веб-разработка (HTML, CSS, JavaScript, фреймворки)
   - Системное администрирование (Linux, сети, безопасность)
   - Архитектура и проектирование (паттерны, принципы SOLID, масштабируемость)
   Определи области, в которых обучающийся демонстрирует уверенные знания.
   Определи области, в которых допускаются ошибки.

3. Анализ паттернов ошибок:
   Выяви типичные паттерны ошибок (например, путаница в базовых концепциях, незнание продвинутых технологий, ошибки в синтаксисе).
   Определи закономерности ошибочных ответов в контексте профессиональных компетенций.
   Оцени, указывают ли ошибки на недостаток базовых знаний или на незнание продвинутых концепций.

4. Определение уровня на основе комплексного анализа:
   Уровень 1 (начальный) — базовые навыки программирования:
   - Большинство ответов неверны или не отвечены
   - Ошибки указывают на недостаток базовых знаний (синтаксис, базовые конструкции)
   - Неполнота ответов по большинству вопросов
   - Правильные ответы только на простейшие вопросы
   
   Уровень 2 (средний) — продвинутые технологии и фреймворки:
   - Правильные ответы на большинство вопросов базового и среднего уровня
   - Ошибки в продвинутых темах (архитектура, оптимизация, масштабируемость)
   - Уверенные знания в 2-3 областях ИТ-компетенций
   - Неполнота ответов на сложные вопросы допустима
   
   Уровень 3 (продвинутый) — архитектурные решения и управление проектами:
   - Правильные ответы на большинство вопросов, включая сложные
   - Уверенные знания во всех или большинстве областей ИТ-компетенций
   - Ошибки редки и связаны с узкоспециализированными темами
   - Демонстрирует понимание архитектурных решений и принципов проектирования

5. Учёт контекста:
   Если обучающийся ответил на все вопросы правильно — это указывает на высокий уровень (2 или 3).
   Если обучающийся ответил на все вопросы, но многие неверны — проанализируй характер ошибок для определения уровня.
   Если много неотвеченных вопросов — это может указывать на недостаточный уровень подготовки (1 или 2).

Вывод:
Выдай строго число 1, 2 или 3 без объяснений, основываясь на комплексном анализе всех факторов.
"""




async def get_gigachat_token() -> str:
    """Получает токен для GigaChat API через OAuth"""
    async with aiohttp.ClientSession() as session:
        # Генерируем случайный RqUID
        rquid = str(uuid.uuid4())
        
        headers = {
            "Authorization": f"Basic {settings.gigachat_authorization_token}",
            "RqUID": rquid,
            "Content-Type": "application/x-www-form-urlencoded",
            "Accept": "*/*",
            "User-Agent": "MoodleEntranceTesting/1.0",
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "Accept-Encoding": "gzip, deflate, br"
        }
        
        # Данные для OAuth запроса
        data = {
            "scope": "GIGACHAT_API_PERS"
        }
        
        try:
            async with session.post(
                settings.gigachat_oauth_url, 
                headers=headers, 
                data=data,
                ssl=False
            ) as response:
                if response.status == 200:
                    result = await response.json()
                    return result["access_token"]
                else:
                    error_text = await response.text()
                    raise Exception(f"Ошибка получения токена: {response.status} - {error_text}")
        except Exception as e:
            raise Exception(f"Ошибка при запросе токена GigaChat: {e}")


async def analyze_results(results_json: dict) -> int:
    print(results_json)
    """Отправляет результаты теста в нейросеть и получает уровень"""
    
    # Получаем свежий токен для GigaChat
    ai_token = await get_gigachat_token()
    
    async with aiohttp.ClientSession() as session:
        headers = {"Authorization": f"Bearer {ai_token}", "Content-Type": "application/json"}
        payload = {
            "model": settings.ai_model,
            "messages": [{"role": "user", "content": PROMPT_TEMPLATE.format(results=json.dumps(results_json, ensure_ascii=False, indent=2))}],
        }

        async with session.post(settings.ai_api_url, json=payload, headers=headers, ssl=False) as r:
            data = await r.json()
            print(
                f"DEBUG: Тип ответа ИИ: {type(data)}, ключи: {list(data.keys()) if isinstance(data, dict) else 'не dict'}")
            print(data)

            try:
                text = data["choices"][0]["message"]["content"].strip()
                # Парсим JSON из ответа ИИ
                print(text)
                level = int(text)
                return level
            except Exception as e:
                raise f"Ошибка при разборе ответа ИИ: {e}"


